<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>VR Explorer</title>
    
    <link rel="manifest" href="manifest.json">
    
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-simple-slider@1.1.0/dist/aframe-simple-slider.min.js"></script>
    
    <link rel="stylesheet" href="style.css">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="VR Explorer">
    <link rel="apple-touch-icon" href="icons/icon-192.png">

</head>
<body>

    <div id="home-screen">
        <h1><i>VR Explorer</i></h1>
        
        <h2>Step 1: Select Simulation</h2>
        <div class="dropdown-container">
            <select id="dropdown-audiences">
                <option value="">Presentation Audiences...</option>
                </select>
        </div>
        
        <p class="or-divider">or</p>

        <div class="dropdown-container">
            <select id="dropdown-scenarios">
                <option value="">Special Scenarios...</option>
                </select>
        </div>

        <h2>Step 2: Enter Simulation</h2>
        <button id="go-button">Go</button>

        <h3 class="optional-title">Optional Settings</h3>
        <div class="toggle-container">
            <label class="switch">
                <input type="checkbox" id="safe-mode-1">
                <span class="slider"></span>
            </label>
            <span>Safe Mode 1</span>
        </div>
        <div class="toggle-container">
            <label class="switch">
                <input type="checkbox" id="safe-mode-2">
                <span class="slider"></span>
            </label>
            <span>Safe Mode 2</span>
        </div>
        <div class="toggle-container">
            <label class="switch">
                <input type="checkbox" id="safe-mode-3">
                <span class="slider"></span>
            </label>
            <span>Safe Mode 3</span>
        </div>

        <footer>
            <i>VR Explorer 1.1 brought to you by Cambridge VR</i>
        </footer>
    </div>

    <div id="video-screen">
        <a-scene id="vr-scene">
            <a-assets>
                <video id="video-src" loop playsinline muted crossorigin="anonymous"></video>
            </a-assets>
            
            <a-videosphere id="video-sphere" src="#video-src"></a-videosphere>

            <a-entity id="camera-rig" position="0 0 0">
                <a-camera id="camera" fov="80">
                    <a-cursor id="cursor" visible="false" fuse="true" fuse-timeout="1500"></a-cursor>
                </a-camera>
            </a-entity>

            <a-entity id="in-vr-slider" position="0 -0.8 -2" visible="false" 
                      simple-slider="width: 1.0; height: 0.1; value: 0.5">
                <a-entity class="slider-thumb" geometry="primitive: plane; width: 0.1; height: 0.1" material="color: #007aff"></a-entity>
            </a-entity>
        </a-scene>

        <div id="loader"></div>
        
        <button id="play-button">â–¶</button>

        <button id="back-button">âœ–</button>
        <button id="unmute-button">ðŸ”ˆ</button>
    </div>


    <script src="video-data.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Get UI Elements ---
            const homeScreen = document.getElementById('home-screen');
            const videoScreen = document.getElementById('video-screen');
            const goButton = document.getElementById('go-button');
            const backButton = document.getElementById('back-button');
            const unmuteButton = document.getElementById('unmute-button');
            const loader = document.getElementById('loader');
            const playButton = document.getElementById('play-button');
            
            const dropdownAudiences = document.getElementById('dropdown-audiences');
            const dropdownScenarios = document.getElementById('dropdown-scenarios');
            const safeMode1 = document.getElementById('safe-mode-1');
            const safeMode2 = document.getElementById('safe-mode-2');
            const safeMode3 = document.getElementById('safe-mode-3');
            
            const vrScene = document.getElementById('vr-scene');
            const videoAsset = document.getElementById('video-src');
            const videoSphere = document.getElementById('video-sphere');
            const camera = document.getElementById('camera');
            const cursor = document.getElementById('cursor');
            const inVrSlider = document.getElementById('in-vr-slider');

            // --- Populate Dropdowns ---
            Object.keys(audienceVideos).forEach(key => dropdownAudiences.add(new Option(key, key)));
            Object.keys(scenarioVideos).forEach(key => dropdownScenarios.add(new Option(key, key)));

            // --- Dropdown Logic ---
            dropdownAudiences.addEventListener('change', () => { if (dropdownAudiences.value) dropdownScenarios.value = ''; });
            dropdownScenarios.addEventListener('change', () => { if (dropdownScenarios.value) dropdownAudiences.value = ''; });

            // --- Mutually Exclusive Toggles ---
            function handleToggle(selectedToggle) {
                if (selectedToggle === safeMode1 && safeMode1.checked) {
                    safeMode2.checked = false;
                    safeMode3.checked = false;
                } else if (selectedToggle === safeMode2 && safeMode2.checked) {
                    safeMode1.checked = false;
                    safeMode3.checked = false;
                } else if (selectedToggle === safeMode3 && safeMode3.checked) {
                    safeMode1.checked = false;
                    safeMode2.checked = false;
                }
            }
            safeMode1.addEventListener('change', () => handleToggle(safeMode1));
            safeMode2.addEventListener('change', () => handleToggle(safeMode2));
            safeMode3.addEventListener('change', () => handleToggle(safeMode3));

            
            // --- Core Video Listeners ---
            
            // 1. A-Frame listener: When video is loaded, hide loader and show Play button
            videoSphere.addEventListener('materialvideoloadeddata', () => {
                loader.style.display = 'none';
                playButton.style.display = 'block';
                console.log('A-Frame material loaded, ready to play.');
            });

            // 2. Video Error Handler
            const videoErrorHandler = (e) => {
                console.error("Video Error:", e);
                // Click back *before* the alert to prevent the loop.
                backButton.click();
                alert("Error: The video file could not be loaded. This may be a server (CORS) or network issue. Please try again.");
            };
            

            
            // --- "Go" Button Logic ---
            goButton.addEventListener('click', () => {
                const selectedKey = dropdownAudiences.value || dropdownScenarios.value;
                if (!selectedKey) { alert('Please select a simulation.'); return; }
                const videoInfo = audienceVideos[selectedKey] || scenarioVideos[selectedKey];
                if (!videoInfo) { alert('Could not find video data.'); return; }

                if (safeMode1.checked) {
                    window.location.href = videoInfo.youtube;
                    return;
                }
                
                homeScreen.style.display = 'none';
                videoScreen.style.display = 'block';
                unmuteButton.innerHTML = 'ðŸ”ˆ';
                loader.style.display = 'block';
                playButton.style.display = 'none';
                
                // Re-attach error handler for this new video
                videoAsset.addEventListener('error', videoErrorHandler);
                videoAsset.muted = true; 

                if (safeMode3.checked) {
                    camera.setAttribute('camera', 'fov', 75);
                }

                const isSafeMode2 = safeMode2.checked && !safeMode3.checked;
                inVrSlider.setAttribute('visible', isSafeMode2);
                cursor.setAttribute('visible', isSafeMode2); // Show cursor with slider
                inVrSlider.setAttribute('simple-slider', 'value', 0.5); 
                if (isSafeMode2) {
                    camera.appendChild(inVrSlider);
                }

                videoAsset.setAttribute('src', videoInfo.cloudflare);
                
                if (vrScene.hasLoaded) vrScene.play();
                else vrScene.addEventListener('loaded', () => vrScene.play());

                const isMobile = vrScene.isMobile;
                if (!isMobile) {
                    vrScene.setAttribute('vr-mode-ui', 'enabled', false);
                    document.documentElement.requestFullscreen().catch(e => console.warn('Fullscreen request failed:', e));
                } else {
                    vrScene.setAttribute('vr-mode-ui', 'enabled', true);
                }
            });

            // --- "Tap to Play" Button Logic ---
            playButton.addEventListener('click', () => {
                videoAsset.play();
                playButton.style.display = 'none';
            });

            // --- "Back" Button Logic ---
            backButton.addEventListener('click', () => {
                videoScreen.style.display = 'none';
                homeScreen.style.display = 'block';
                loader.style.display = 'none';
                playButton.style.display = 'none';
                
                // UPDATED: Detach the error handler *first* to prevent loops
                videoAsset.removeEventListener('error', videoErrorHandler);
                videoAsset.onerror = null;

                videoAsset.pause();
                videoAsset.setAttribute('src', ''); 
                vrScene.pause();
                
                videoAsset.muted = true;
                if (inVrSlider.parentNode === camera) {
                    camera.removeChild(inVrSlider);
                }
                camera.setAttribute('camera', 'fov', 80); 
                cursor.setAttribute('visible', false); // Hide cursor on exit
                
                if (document.fullscreenElement) {
                    document.exitFullscreen();
                }
            });

            // --- Unmute Button Logic ---
            unmuteButton.addEventListener('click', () => {
                if (videoAsset.muted) {
                    videoAsset.muted = false;
                    unmuteButton.innerHTML = 'ðŸ”‡'; // UPDATED: Show "Mute" icon
                } else {
                    videoAsset.muted = true;
                    unmuteButton.innerHTML = 'ðŸ”ˆ'; // UPDATED: Show "Unmute" icon
                }
            });

            // --- Safe Mode 2 (IPD Slider) Logic ---
            inVrSlider.addEventListener('sliderchanged', (e) => {
                const ipdValue = (e.detail.value * 0.1) - 0.05; 
                const separation = parseFloat(ipdValue);
                const cameraRig = vrScene.camera; 
                if (cameraRig && cameraRig.el.children.length >= 2) {
                    const leftEye = cameraRig.el.children[0];
                    const rightEye = cameraRig.el.children[1];
                    const baseSeparation = 0.032; 
                    leftEye.setAttribute('position', { x: -baseSeparation + separation, y: 0, z: 0 });
                    rightEye.setAttribute('position', { x: baseSeparation + separation, y: 0, z: 0 });
                }
            });

            // --- PWA Service Worker Registration ---
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    // UPDATED: Path changed to /ExplorerTest22/
                    navigator.serviceWorker.register('/ExplorerTest22/sw.js')
                        .then(reg => console.log('Service Worker registered.', reg))
                        .catch(err => console.error('Service Worker registration failed:', err));
                });
            }
        });
    </script>
</body>
</html>
